<!DOCTYPE html>
<html>

<head>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script> -->
    <title>Neighborhood Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />

    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500|Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp">


    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
</head>

<body>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.css'
        type='text/css' />
    <!-- MapBox -->
    <main id='map'></main>
    <pre id='coordinates' class='coordinates'></pre>
    <!-- end MapBox -->

    <!-- Travel options section -->
    <section class="control-btn-container 
                    control-btn-margins-2
                    mapboxgl-ctrl 
                    mapboxgl-ctrl-group">
        <button class="mdc-button width-100" onclick="confirmationdialog.open()"
            title="Click to change your travel profile"
        >Travel Options</button>
    </section>
    <!-- end Travel options section -->

    <!-- Radio buttons section -->
    <section class="control-btn-container 
                    control-btn-margins 
                    mapboxgl-ctrl 
                    mapboxgl-ctrl-group">

        <div class="mdc-form-field">
            <div class="mdc-radio" title="Swipe to normal mode">
                <input class="mdc-radio__native-control" type="radio" id="radio-1" name="radios" data-bind="checked: markersMode, checkedValue: true"
                    onclick="handleMarkersRadio()">
                <div class="mdc-radio__background">
                    <div class="mdc-radio__outer-circle"></div>
                    <div class="mdc-radio__inner-circle"></div>
                </div>
            </div>
            <label for="radio-1" class="material-icons">add_location</label>
            <script>
                function handleMarkersRadio() {
                    if (markersSnackBar) markersSnackBar.open()
                    clearPointsAndRoute()
                }
            </script>
        </div>
        |
        <div class="mdc-form-field">
            <label for="radio-2" class="material-icons">directions</label>
            <div class="mdc-radio">
                <input class="mdc-radio__native-control" type="radio" id="radio-2" name="radios" data-bind="checked: markersMode, checkedValue: false"
                    onclick="handleDirectionsRadio(event)" title="Swipe to directions mode">
                <div class="mdc-radio__background">
                    <div class="mdc-radio__outer-circle"></div>
                    <div class="mdc-radio__inner-circle"></div>
                </div>
                <script>
                    // It displays the snackbar
                    // and blinks locations list
                    function handleDirectionsRadio(event) {
                        if (directionsSnackBar) directionsSnackBar.open()

                        if (drawer && !drawer.open) toggleDrawer()

                        let el = document.querySelector('.locations-container')
                        el.classList.add("locations-container--hovered")
                        setTimeout(function () { el.classList.remove("locations-container--hovered") }, 1000)
                        setTimeout(function () { el.classList.add("locations-container--hovered") }, 1300)
                        setTimeout(function () { el.classList.remove("locations-container--hovered") }, 2300)
                        setTimeout(function () { el.classList.add("locations-container--hovered") }, 2800)
                        setTimeout(function () { el.classList.remove("locations-container--hovered") }, 3800)
                    }
                </script>
            </div>
        </div>
    </section>
    <!-- end Radio buttons section -->

    <!-- FABs -->
    <button class="mdc-fab open-drawer" onclick="toggleDrawer()">
        <span title="Click to open drawer" class="mdc-fab__icon material-icons">swap_horiz</span>
    </button>
    <button class="mdc-fab fab-close-popups" onclick="closePopups()">
        <span title="Click to close popups" class="mdc-fab__icon material-icons">delete_sweep</span>
    </button>
    <button class="mdc-fab fab-close-venue-markers" onclick="closeVenues()">
        <span title="Click to close venue markers" class="mdc-fab__icon material-icons">location_off</span>
    </button>
    <!-- end FABs -->
    
    <!-- Drawer -->
    <aside class="mdc-drawer mdc-drawer--dismissible mdc-drawer--open">
        <div class="mdc-drawer__content">
            <nav class="mdc-list my-markers-container">

                <div class="width-100">
                    <button class="mdc-icon-button my-mdc-fab material-icons" onclick="toggleDrawer()"
                        title="Click to close drawer"
                    >
                        swap_horiz
                    </button>
                    <a class="mdc-list-item locations-title" href="javascript:" aria-selected="true">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">apps</i>
                        <h3 class="mdc-list-item__text width-100">
                            Locations
                        </h3>
                    </a>
                </div>
                <script>
                    function toggleDrawer() {
                        let viewModel = ko.dataFor(document.body)
                        viewModel.isDrawerOpen(!drawer.open)
                        drawer.open = !drawer.open
                    };
                </script>

                <div class="locations-container">
                    <div data-bind="ifnot: hasFilter">
                        <div data-bind="foreach: markers">
                            <li class="mdc-list-item my-list-item" data-bind="text: address_name, attr: {'data-center': center}" onclick="handleClick(event)"></li>
                        </div>
                    </div>
                    <div data-bind="if: hasFilter">
                        <div data-bind="foreach: filteredElements">
                            <li class="mdc-list-item my-list-item" data-bind="text: address_name, attr: {'data-center': center}" onclick="handleClick(event)"></li>
                        </div>
                    </div>
                    <script>
                        function handleClick(e) {
                            let viewModel = ko.dataFor(document.body)

                            let center = e.target
                                .getAttribute("data-center")
                                .split(",")

                            if (viewModel.markersMode())
                                centerOnThisMarker()
                            else
                                selectDirectionPoints()

                            function centerOnThisMarker() {
                                if (map) map.flyTo({ center })
                            }

                            function selectDirectionPoints() {

                                if (!viewModel.origin()) {
                                    viewModel.origin({ x: center[0], y: center[1] })
                                    e.target.className += ' directions-origin'
                                    centerOnThisMarker()

                                } else if (!viewModel.destination()) {
                                    viewModel.destination({ x: center[0], y: center[1] })
                                    e.target.className += ' directions-destination'
                                    discoverDirections()
                                } else if (alertdialog) alertdialog.open()

                            }

                        }

                    </script>
                </div>
                <div class="mdc-tab-bar" role="tablist">
                    <div class="mdc-tab-scroller">
                        <div class="mdc-tab-scroller__scroll-area">
                            <div class="mdc-tab-scroller__scroll-content">
                                <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">place</span>
                                    </span>
                                    <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                                <button class="mdc-tab " role="tab" aria-selected="false">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">near_me</span>
                                    </span>
                                    <span class="mdc-tab-indicator">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="text-field-container input-container">
                        <div class="mdc-text-field text-field mdc-text-field--no-label mdc-ripple-upgraded my-input">
                            <input type="text" id="text-field-filled" class="mdc-text-field__input" aria-label="Text field aria label" data-bind="textInput: filterQuery">
                            <div class="mdc-line-ripple"></div>
                        </div>
                        <div class="mdc-text-field-helper-line">
                            <p class="mdc-text-field-helper-text 
                                        mdc-text-field-helper-text--persistent 
                                        mdc-text-field-helper-text--validation-msg" id="pw-validation-msg">
                                Search your locations
                            </p>
                        </div>
                    </div>

                </div>
            </nav>

        </div>
    </aside>
    <!-- end Drawer -->

    <!-- MDCDialog -->
    <!-- Alert Dialog -->
    <div class="mdc-dialog" id="alertdialog" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title" aria-describedby="my-dialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                <h2 class="mdc-dialog__title" id="my-dialog-title">
                    <!--
                    -->
                    Are you sure?
                    <!-- 
            -->
                </h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    This action will clear both origin and destination points.
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="no">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="yes" onclick="clearPointsAndRoute()">
                        <span class="mdc-button__label">Ok, clear</span>
                    </button>
                </footer>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <!-- end Alert Dialog -->
    <!-- Confirmation Dialog -->
    <div class="mdc-dialog" id="confirmationdialog" role="alertdialog" aria-modal="true" aria-labelledby="my-cdialog-title" aria-describedby="my-cdialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                <h2 class="mdc-dialog__title" id="my-dialog-title">
                    <!--
                        -->Choose a travel profile
                    <!--
                    -->
                </h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    <ul class="mdc-list">
                        <li class="my-radio-list" tabindex="0">
                            <span class="mdc-list-item__graphic">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="test-dialog-baseline-confirmation-radio-1" name="test-dialog-baseline-confirmation-radio-group"
                                        checked data-bind="checked: travelProfile, checkedValue: 'cycling'">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                </div>
                            </span>
                            <label id="test-dialog-baseline-confirmation-radio-1-label" for="test-dialog-baseline-confirmation-radio-1" class="mdc-list-item__text">
                                Cycling
                            </label>
                        </li>
                        <li class="my-radio-list" tabindex="1">
                            <span class="mdc-list-item__graphic">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="test-dialog-baseline-confirmation-radio-2" name="test-dialog-baseline-confirmation-radio-group"
                                        data-bind="checked: travelProfile, checkedValue: 'driving'">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                </div>
                            </span>
                            <label id="test-dialog-baseline-confirmation-radio-2-label" for="test-dialog-baseline-confirmation-radio-2" class="mdc-list-item__text">
                                Driving
                            </label>
                        </li>
                        <li class="my-radio-list" tabindex="2">
                            <span class="mdc-list-item__graphic">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="test-dialog-baseline-confirmation-radio-3" name="test-dialog-baseline-confirmation-radio-group"
                                        data-bind="checked: travelProfile, checkedValue: 'walking'">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                </div>
                            </span>
                            <label id="test-dialog-baseline-confirmation-radio-3-label" for="test-dialog-baseline-confirmation-radio-3" class="mdc-list-item__text">
                                Walking
                            </label>
                        </li>
                        <!-- ... -->
                    </ul>
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="accept" onclick="handleConfirmation()">
                        <span class="mdc-button__label">OK</span>
                    </button>
                </footer>
            </div>
            <script>
                function handleConfirmation() {
                    // the ViewModel instance 
                    const viewModel = ko.dataFor(document.body)
                    if (viewModel.origin() && viewModel.destination())
                        discoverDirections();
                }
            </script>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <!-- end Confirmation Dialog -->
    <!-- end MDCDialog -->

    <!-- MDCSnackbar -->
    <!-- markers SnackBar -->
    <div id="directionsSnack" class="mdc-snackbar mdc-snackbar--closing">
        <div class="mdc-snackbar__surface">
            <div class="mdc-snackbar__label" role="status" aria-live="polite">
                <div>Choose your origin and destination points</div>
                <div>by clicking your locations' list items!</div>
            </div>

        </div>
    </div>
    <!-- end markers SnackBar -->
    <!-- directions SnackBar -->
    <div id="markersSnack" class="mdc-snackbar mdc-snackbar--closing">
        <div class="mdc-snackbar__surface">
            <div class="mdc-snackbar__label" role="status" aria-live="polite">
                <div>Create markers from your favorite locations by clicking the map.</div>
                <br/>
                <div>Move around map with arrow keys!</div>
            </div>

        </div>
    </div>
    <!-- end directions SnackBar -->
    <!-- end MDCSnackbar -->

    <script src="./js/ViewModel.js"></script>
    <script>

        const drawer = new mdc.drawer.MDCDrawer.attachTo(document.querySelector('.mdc-drawer'))
        const tabBar = new mdc.tabBar.MDCTabBar(document.querySelector('.mdc-tab-bar'))
        const alertdialog = new mdc.dialog.MDCDialog(document.querySelector('#alertdialog'))
        const confirmationdialog = new mdc.dialog.MDCDialog(document.querySelector('#confirmationdialog'))
        const directionsSnackBar = new mdc.snackbar.MDCSnackbar(document.querySelector('#directionsSnack'))
        const markersSnackBar = new mdc.snackbar.MDCSnackbar(document.querySelector('#markersSnack'))
        markersSnackBar.timeoutMs = 6000

    </script>
    
    <script>

        const mapBoxAccessToken = `pk.eyJ1IjoicmVpc21hdGhldXM5NyIsImEiOiJjanV5eHhtNjkxMjJnM3lydmFqdjBodXB4In0.B97LD8MDr6PdY2LiEWvhEA`
        mapboxgl.accessToken = mapBoxAccessToken

        // Mapbox Map instance
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v11',
            center: [-43.17614100000003, -22.910430000000034],
            zoom: 14,
        })

        // Used to draw a line between points
        var linestring = {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": []
            }
        }

        // Add MapBox Geocoder element
        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            zoom: 17,
            placeholder: "Where?",
            reverseGeocode: true
        }))

        // Add MapBox Navigation Controls element
        map.addControl(new mapboxgl.NavigationControl())

        // Add Geolocate element (needs user allowment)
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }))

        map.on('click', createMarker)

        // Create an marker and add it to the map.
        // It fetches Mapbox Locations API 
        function createMarker(e) {
            let center = [e.lngLat.lng, e.lngLat.lat]
            
            // URL with latitute and longitude (latlng)
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
                `${center[0]},${center[1]}.json?access_token=${mapBoxAccessToken}`
            
            // the ViewModel instance 
            const viewModel = ko.dataFor(document.body)

            let address_name = "",
                place = "",
                country = ""
            
            // If not on directions mode, fetch Mapbox Locations API using jQuery's AJAX
            if (viewModel.markersMode()) {
                $.get({
                    url,
                    context: document.body
                }).done(function (result) {
                    
                    // If there are features, fill `address_name`, `place` and `country` values
                    if (result.features && result.features.length > 0) {
                        
                        if (result.features[0].place_name) {
                            address_name = result.features[0].place_name.split(",").splice(0, 1).join()
                        }

                        place = result.features.find(it => it.place_type == "place")
                        country = result.features.find(it => it.place_type == "country")

                        if (place) {
                            address_name += ", " + place.text
                            place = place.text
                        }

                        if (country) {
                            let country_code = country.properties.short_code.toUpperCase()
                            address_name += ", " + country_code
                            contry = country_code
                        }

                    } else {
                        address_name = "No where!"
                    }

                }).fail(function (xhr, textStatus, errorThrown) {
                    // Error handling
                    console.warn("Fail to fetch mapbox geocoding API. " + (errorThrown || ""))
                    address_name = ""
                }).always(function () {    // Do always, regardless of success or error    

                    // Only creates a popup if the address is specific enough
                    // to perform a sense fetches on Foursquare API.
                    let isSearchableAddress = address_name.split(",").length > 2
                    if (isSearchableAddress) {
                        // Creates Mapbox Popup instance
                        var popup = new mapboxgl.Popup({
                            offset: 1,
                            anchor: 'top',
                            closeOnClick: false
                        })
                            .setDOMContent( // Setting popup's custom element
                                popupTemplate(
                                    address_name
                                )
                            )
                            .setLngLat(center)
                        
                        // Add popup instance to the ViewModel
                        viewModel.addPopups(popup)
                    }
                    
                    // Setting marker's custom element
                    // First, creates a container to the marker
                    let markerContainer = document.createElement('div');
                    markerContainer.className = 'marker-container'

                    // Second, creates the marker element
                    let markerIcon = document.createElement('i')

                    // Customizing marker element
                    markerIcon.className = 'material-icons marker'
                    markerIcon.textContent = 'place'
                    markerIcon.onclick = function (e) {
                        e.stopPropagation()
                        if (isSearchableAddress) popup.addTo(map)
                        viewModel.activeMarker({ center, address_name })
                        map.easeTo({ center })
                    };

                    // Append marker to its container
                    markerContainer.appendChild(markerIcon)

                    // Aligns viewport and map centers slowly
                    map.easeTo({ center })
                    
                    // Creates Mapbox Marker instance and appends it to its marker container
                    let marker = new mapboxgl.Marker(markerContainer)
                        .setLngLat(center)
                        .addTo(map)

                    // Add marker instance to ViewModel
                    viewModel.addMarker({
                        center,
                        address_name,
                        markerMapBox: marker
                    })

                })
            } else {
                // Aligns viewport and map centers normally
                map.flyTo({ center });
            }
        }
        // End create marker

        // It fetches the Foursquare API to retrieve information
        // about nearby venues of a specific location.
        function fetchFoursquareAPI() {

            // the ViewModel instance 
            const viewModel = ko.dataFor(document.body)

            // Get the active marker's center
            const center = viewModel.activeMarker().center
            
            // Foursquare URL with a longitude, latitude, client id and client secret
            const foursquareClientID = `EHBZPGPP5CFESEZAXKUORTOT5EMHUHKZPA1DRAXC3MYLFH2R`
            const foursquareClientSecret = `FFYFDZLLIYO2OKN3VUJZIQ0WM2GTQIPTZHXZAEDXSIWJFHE1`
            let foursquareUrl = `https://api.foursquare.com/v2/venues/search?ll=` +
                `${center[1] + ',' + center[0]}&client_id=${foursquareClientID}` +
                `&client_secret=${foursquareClientSecret}&v=20190401&limit=5&llAcc=1.0&radius=250`

            // Fetches Fourquare API using jQuery's AJAX
            $.get({
                url: foursquareUrl,
                context: document.body
            }).done(function (result) {
                if (
                    result.response &&
                    result.response.venues &&
                    result.response.venues.length > 0
                ) {
                    // If there are venues, fill temporaryVenues array
                    let temporaryVenues = result.response.venues.map(
                        it => {
                            let venue = {}
                            let address_name = ""

                            // A venue always need to has name and center (longitude, latitude)
                            venue = {
                                name: it.name,
                                center: [it.location.lng, it.location.lat]
                            }

                            // If there are a valid location and address,
                            // fill `adress_name` values
                            if (it.location.address) {
                                address_name = it.location.address
                                if (it.location.city) { ", " + it.location.city }
                                if (it.location.cc) { ", " + it.location.cc }
                                venue = { ...venue, address_name }
                                
                                // Create Mapbox Popup instance
                                var popup = new mapboxgl.Popup({
                                    offset: 1,
                                    anchor: 'top',
                                    closeOnClick: false
                                })
                                    .setDOMContent( // Set custom popup element
                                        popupTemplate(
                                            venue.name + "," + venue.address_name,
                                            true
                                        )
                                    )
                                    .setLngLat(venue.center);
                                
                                // Add popup instance to the ViewModel
                                viewModel.addPopups(popup)
                                
                                // Setting marker's custom element
                                // First, creates a container to the marker
                                let markerContainer = document.createElement('div');
                                markerContainer.className = 'marker-container';

                                // Second, creates the marker element
                                let markerIcon = document.createElement('i');

                                // Customizing venue marker element
                                markerIcon.className = 'material-icons venue';
                                markerIcon.textContent = 'place';
                                markerIcon.onclick = function (e) {
                                    e.stopPropagation();
                                    popup.addTo(map)
                                    map.easeTo({ center: venue.center });
                                };

                                // Append venue marker to its container
                                markerContainer.appendChild(markerIcon);

                                // Creates Mapbox Marker instance and appends it to its marker container
                                let markerVenue = new mapboxgl.Marker(markerContainer)
                                    .setLngLat(venue.center)
                                    .addTo(map)
                                
                                venue = { ...venue, venueMarkerMapBox: markerVenue }

                                // Add venue marker instance to the ViewModel
                                viewModel.addVenueMarker(venue)

                                return venue
                            }

                        }
                    )

                }

            }).fail(function (xhr, textStatus, errorThrown) {
                // Error handling
                console.warn("Fail to fetch Foursquare API. " + (errorThrown || ""));
            })

        }

        // Transform a string into a HTML element.
        // It uses HTML5' template feature.
        function htmlToElement(html) {
            let templateEl = document.createElement('template');
            html = html.trim();
            templateEl.innerHTML = html;
            return templateEl.content.firstChild;
        }

        // Function to create a custom popup template using Material Design' card component
        function popupTemplate(text, withoutActions) {
            
            let title = text.split(",").splice(0, 1).join()
            let subtitle = text.split(",").splice(1).join()
            let templateActions = ``

            if (text.split(",").length > 2 && !withoutActions) {
                templateActions = `
                    <div class="mdc-card__actions">
                        <div class="mdc-card__action-buttons">
                        <button class="mdc-button mdc-card__action mdc-card__action--button" onclick="fetchFoursquareAPI(event)">
                            <span class="mdc-button__label" style="width: max-content;">Find nearby venues</span>
                            <img  class="mdc-button__icon" src="assets/foursquare-icon.svg" onerror="this.src=assets/foursquare.svg'"
                                style="width: 30px; height: 30px"
                            />
                        </button>
                        </div>
                        <div class="mdc-card__action-icons">
                            <button class="material-icons mdc-icon-button mdc-card__action mdc-card__action--icon" title="More options">more_vert</button>
                        </div>
                    </div>
                `
            }

            let template = `
            <div class="mdc-card">
                <div class="mdc-card__primary-action mdc-card-title-custom">    
                    <span class="mdc-typography mdc-typography--subtitle1">${title}</span>
                    <span class="mdc-typography mdc-typography--subtitle2">${subtitle}</span>
                    <div id="ttt" style="display: none; height: 100px">
                        <hr/>    
                    </div>
                </div>
                ${templateActions}
            </div>
            `
            template = htmlToElement(template)
            return template
        }

        // It clears both points and route. (Element related with directions mode)
        function clearPointsAndRoute() {
            // the ViewModel instance 
            const viewModel = ko.dataFor(document.body);

            if (viewModel.origin()) {
                document.querySelector(".directions-origin")
                    .classList.remove("directions-origin");

                if (viewModel.destination()) {
                    document.querySelector(".directions-destination")
                        .classList.remove("directions-destination");

                    map.removeLayer('route');
                    map.removeSource('route');
                }

            }

            viewModel.origin("");
            viewModel.destination("");

        }

        // It fethces Mapbox Directrions API to discover directions between two points.
        function discoverDirections() {

            // the ViewModel instance 
            const viewModel = ko.dataFor(document.body)

            // Origin
            const A = viewModel.origin()
            // Destination
            const B = viewModel.destination()
            // Travel profile (one of: 'walking', 'cycling', 'driving')
            const profile = viewModel.travelProfile();
            
            // URL to Mapbox Directions API with both origin and destination points (A and B, respectively)
            const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/${profile.toLowerCase()}/` +
                `${A.x},${A.y};${B.x},${B.y}?` +
                `overview=full&geometries=geojson&access_token=` + mapBoxAccessToken;
            
            // It uses jQuery's AJAX to perform GET request
            $.get({
                url: directionsUrl
            })
                .done(function (result) {
                    // If there are routes between the given points
                    if (result.routes && result.routes.length > 0) {

                        // It stores in route's data and creates a feature
                        // using GeoJSON feature. This makes possible to draw
                        // the route on the map.
                        let data = result.routes[0];
                        let route = data.geometry.coordinates;
                        let geojson = {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'LineString',
                                coordinates: route
                            }
                        };

                        // If already exists source 'route', just set new route
                        // using the GeoJSON
                        if (map.getSource('route')) {
                            map.getSource('route').setData(geojson);
                        } else {
                            // Else, creates the layer source named 'route'
                            map.addLayer({
                                id: 'route',
                                type: 'line',
                                source: {
                                    type: 'geojson',
                                    data: {
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'LineString',
                                            coordinates: geojson
                                        }
                                    }
                                },
                                layout: {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                paint: {
                                    'line-color': '#6200ee',  // Route's color
                                    'line-width': 5,  // Route's width
                                    'line-opacity': 1  // Route's opacity
                                }
                            })

                            // Set source's data with GeoJSON
                            map.getSource('route').setData(geojson);
                        }
                        
                        // Toggle drawer's visibility
                        if (drawer && !drawer.open) toggleDrawer()

                    }
                }).fail(function (xhr, textStatus, errorThrown) {
                    // Error handling
                    console.warn("Fail to fetch mapbox directions API. " + (errorThrown || ""));
                })
        }

        // It closes all popups
        function closePopups() {
            let viewModel = ko.dataFor(document.body)
            viewModel.popups().map(it => it.remove())
        }

        // It closes all venue markers
        function closeVenueMarkers() {
            let viewModel = ko.dataFor(document.body)
            viewModel.venues()
        }


    </script>

</body>

</html>