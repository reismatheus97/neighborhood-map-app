<!DOCTYPE html>
<html>

<head>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script> -->
    <title>Neighborhood Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>

    <style>
        body {
            margin: 0px;
            padding: 0px;
        }

        .container {
            width: 100%;
            height: 100%;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 100%;
        }

        .coordinates {
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            position: absolute;
            bottom: 10px;
            left: 10px;
            padding: 5px 10px;
            margin: 0;
            font-size: 11px;
            line-height: 18px;
            border-radius: 3px;
            display: none;
        }

        .floating-section {

            margin: 20px;
            padding: 0px;
            position: absolute;
            z-index: 1;
        }

        .input-wrapper {
            width: 100%;
            height: 100%;
        }

        .my-icon {
            font-size: 40px;
        }

        .my-icon-container {
            min-width: 60px;
            min-height: 60px;
        }

        .mdc-drawer {
            z-index: 100 !important;
            height: calc(100% - 45px);
            margin: 10px 10px;
        }

        .my-markers {
            height: calc(100% - 16px);
            display: flex;
            flex-direction: column;
        }

        .locations-container {
            margin: 8px;
            padding: 8px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .my-div {
            /* background-color: red; */
            height: 100%;
            position: absolute;
        }

        .my-input {
            margin: 8px;
            padding: 0 8px;
        }

        .my-list-item {
            height: auto !important;
        }
    </style>
</head>

<body>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.css'
        type='text/css' />
    <div id='map'></div>
    <pre id='coordinates' class='coordinates'></pre>
    <div class="my-div">
        <aside class="mdc-drawer">
            <div class="mdc-drawer__content">
                <nav class="mdc-list my-markers">

                    <div>
                        <a class="mdc-list-item mdc-list-item--activated" href="#" aria-selected="true">
                            <i class="material-icons mdc-list-item__graphic" aria-hidden="true">apps</i>
                            <h3 class="mdc-list-item__text">Locations</h3>
                        </a>
                    </div>

                    <div class="locations-container">
                        <div data-bind="ifnot: hasFilter">
                            <div data-bind="foreach: markers">
                                <li class="mdc-list-item my-list-item" data-bind="text: place_name, attr: {'data-center': center}" onclick="centerOnThisMarker(event)"></li>
                            </div>
                        </div>
                        <div data-bind="if: hasFilter">
                            <div data-bind="foreach: filteredElements">
                                <li class="mdc-list-item my-list-item" data-bind="text: place_name, attr: {'data-center': center}" onclick="centerOnThisMarker(event)"></li>
                            </div>
                        </div>
                        <script>
                            function centerOnThisMarker(e) {
                                if (map)
                                    map.flyTo({
                                        center: e.target
                                            .getAttribute("data-center")
                                            .split(",")
                                    })
                            }
                        </script>
                    </div>
                    <div class="mdc-tab-bar" role="tablist">
                        <div class="mdc-tab-scroller">
                            <div class="mdc-tab-scroller__scroll-area">
                                <div class="mdc-tab-scroller__scroll-content">
                                    <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true">
                                        <span class="mdc-tab__content">
                                            <span class="mdc-tab__icon material-icons" aria-hidden="true">place</span>
                                        </span>
                                        <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                        </span>
                                        <span class="mdc-tab__ripple"></span>
                                    </button>
                                    <button class="mdc-tab " role="tab" aria-selected="false">
                                        <span class="mdc-tab__content">
                                            <span class="mdc-tab__icon material-icons" aria-hidden="true">favorite</span>
                                        </span>
                                        <span class="mdc-tab-indicator">
                                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                        </span>
                                        <span class="mdc-tab__ripple"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="text-field-container my-input">
                            <div class="mdc-text-field text-field mdc-text-field--no-label mdc-ripple-upgraded">
                                <input type="text" id="text-field-filled" class="mdc-text-field__input" aria-label="Text field aria label" data-bind="textInput: filterQuery">
                                <div class="mdc-line-ripple"></div>
                            </div>
                            <div class="mdc-text-field-helper-line">
                                <p class="mdc-text-field-helper-text 
                                        mdc-text-field-helper-text--persistent 
                                        mdc-text-field-helper-text--validation-msg" id="pw-validation-msg">
                                    Search your locations
                                </p>
                            </div>
                        </div>

                    </div>
                </nav>

            </div>
        </aside>
    </div>

    <script src="./js/app.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
    <script>

        const accessToken = `pk.eyJ1IjoicmVpc21hdGhldXM5NyIsImEiOiJjanRncWRiZTQwNWxjNDRsZms1djc1NHIyIn0.fvM81OoCXOijNBcWWDtBMA`;
        mapboxgl.accessToken = accessToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-87.637596, 41.940403],
            zoom: 12,
        });

        var geojson = {
            "type": "FeatureCollection",
            "features": []
        };

        // Used to draw a line between points
        var linestring = {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": []
            }
        };

        var customData = {
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Lincoln Park",
                        "description": "A northside park that is home to the Lincoln Park Zoo"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.637596,
                            41.940403
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Burnham Park",
                        "description": "A lakefront park on Chicago's south side"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.603735,
                            41.829985
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Millennium Park",
                        "description": "A downtown park known for its art installations and unique architecture"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.622554,
                            41.882534
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Grant Park",
                        "description": "A downtown park that is the site of many of Chicago's favorite festivals and events"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.619185,
                            41.876367
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Humboldt Park",
                        "description": "A large park on Chicago's northwest side"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.70199,
                            41.905423
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Douglas Park",
                        "description": "A large park near in Chicago's North Lawndale neighborhood"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.699329,
                            41.860092
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Calumet Park",
                        "description": "A park on the Illinois-Indiana border featuring a historic fieldhouse"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.530221,
                            41.715515
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Jackson Park",
                        "description": "A lakeside park that was the site of the 1893 World's Fair"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.580389,
                            41.783185
                        ],
                        "type": "Point"
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "title": "Columbus Park",
                        "description": "A large park in Chicago's Austin neighborhood"
                    },
                    "geometry": {
                        "coordinates": [
                            -87.769775,
                            41.873683
                        ],
                        "type": "Point"
                    }
                }
            ],
            "type": "FeatureCollection"
        };

        function forwardGeocoder(query) {
            var matchingFeatures = [];
            for (var i = 0; i < customData.features.length; i++) {
                var feature = customData.features[i];
                // handle queries with different capitalization than the source data by calling toLowerCase()
                if (feature.properties.title.toLowerCase().search(query.toLowerCase()) !== -1) {
                    // add a tree emoji as a prefix for custom data results
                    // using carmen geojson format: https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                    feature['place_name'] = '🌲 ' + feature.properties.title;
                    feature['center'] = feature.geometry.coordinates;
                    feature['place_type'] = ['park'];
                    matchingFeatures.push(feature);
                }
            }
            return matchingFeatures;
        }

        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            localGeocoder: forwardGeocoder,
            zoom: 14,
            placeholder: "Where?"
        }));

        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }));

        map.addControl(new mapboxgl.NavigationControl());

        map.on('click', createMarker);

        // Create an marker and add it to the map
        function createMarker(e) {
            let center = [e.lngLat.lng, e.lngLat.lat]

            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
                `${center[0]},${center[1]}.json?access_token=${accessToken}`

            const viewModel = ko.dataFor(document.body)
            let place_name = ""

            $.get({
                url,
                context: document.body
            }).done(function (result) {
                console.log("ajax result >>", result);

                if (result.features && result.features.length > 0) {

                    if (result.features[0].place_name) {
                        place_name = result.features[0].place_name.split(",").splice(0, 2).join();
                    }

                    let country = result.features.find(it => it.place_type == "country")

                    if (country) {
                        let country_code = country.properties.short_code.toUpperCase();
                        place_name += ", " + country_code;
                    }

                } else {
                    places = [
                        "A very far place.",
                        "Undefined. Really.",
                        "There is no data avail"
                    ]
                    place_name = ""
                }

            }).fail(function (xhr, textStatus, errorThrown) {
                console.warn("Fail to fetch mapbox geocoding API. " + (errorThrown || ""));
                place_name = ""
            }).always(function () {
                viewModel.addMarker({ center, place_name });
            })


            map.flyTo({ center });
            var marker = new mapboxgl.Marker()
                .setLngLat(center)
                .addTo(map)

            const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/cycling/` + 
                        `${center[0]},${center[1]};-84.512023,39.102779?` + 
                        `overview=full&geometries=geojson&access_token=` + accessToken;

            $.get({
                url: directionsUrl
            })
                .done(function (result) {
                    console.log("result >>", result)
                    if (result.routes && result.routes.length > 0) {
                        let data = result.routes[0];
                        let route = data.geometry.coordinates;
                        let geojson = {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'LineString',
                                coordinates: route
                            }
                        };

                        if (map.getSource('route')) {
                            map.getSource('route').setData(geojson);
                        } else {
                            map.addLayer({
                                id: 'route',
                                type: 'line',
                                source: {
                                    type: 'geojson',
                                    data: {
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'LineString',
                                            coordinates: geojson
                                        }
                                    }
                                },
                                layout: {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                paint: {
                                    'line-color': '#6200ee',
                                    'line-width': 5,
                                    'line-opacity': 1
                                }
                            })
                        }

                    }
                })
                .fail(function (xhr, textStatus, errorThrown) {
                    console.warn("Fail to fetch mapbox directions API. " + (errorThrown || ""));
                })

        }

        // map.on('mousemove', function (e) {
        //     var features = map.queryRenderedFeatures(e.point, { layers: ['measure-points'] });
        //     // UI indicator for clicking/hovering a point on the map
        //     map.getCanvas().style.cursor = (features.length) ? 'pointer' : 'crosshair';
        // });

    </script>

</body>

</html>