<!DOCTYPE html>
<html>

<head>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script> -->
    <title>Neighborhood Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />

    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500|Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp">


    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>

</head>

<body>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.css'
        type='text/css' />
    <div id='map'></div>
    <pre id='coordinates' class='coordinates'></pre>
    <section class="control-btn-container 
                    control-btn-margins-2
                    mapboxgl-ctrl 
                    mapboxgl-ctrl-group">
        <button class="mdc-button width-100" onclick="confirmationdialog.open()">Travel Options</button>
    </section>
    <section class="control-btn-container 
                    control-btn-margins 
                    mapboxgl-ctrl 
                    mapboxgl-ctrl-group">

        <div class="mdc-form-field">
            <div class="mdc-radio">
                <input class="mdc-radio__native-control" type="radio" id="radio-1" name="radios" data-bind="checked: markersMode, checkedValue: true"
                    onclick="clearPointsAndRoute()">
                <div class="mdc-radio__background">
                    <div class="mdc-radio__outer-circle"></div>
                    <div class="mdc-radio__inner-circle"></div>
                </div>
            </div>
            <label for="radio-1" class="material-icons">add_location</label>
        </div>
        |
        <div class="mdc-form-field">
            <label for="radio-2" class="material-icons">directions</label>
            <div class="mdc-radio">
                <input class="mdc-radio__native-control" type="radio" id="radio-2" name="radios" data-bind="checked: markersMode, checkedValue: false"
                    onclick="callUserAttention(event)">
                <div class="mdc-radio__background">
                    <div class="mdc-radio__outer-circle"></div>
                    <div class="mdc-radio__inner-circle"></div>
                </div>
                <script>

                    // It displays the snackbar
                    // and blinks locations list
                    function callUserAttention(event) {
                        if (snackbar) snackbar.open();
                        let el = document.querySelector('.locations-container');

                        el.classList.add("locations-container--hovered");
                        setTimeout(function () { el.classList.remove("locations-container--hovered") }, 1000);
                        setTimeout(function () { el.classList.add("locations-container--hovered") }, 1300);
                        setTimeout(function () { el.classList.remove("locations-container--hovered") }, 2300);
                        setTimeout(function () { el.classList.add("locations-container--hovered") }, 2800);
                        setTimeout(function () { el.classList.remove("locations-container--hovered") }, 3800);
                    }
                </script>
            </div>
        </div>
    </section>
    <button class="mdc-fab open-drawer" onclick="toggleDrawer()">
        <span class="mdc-fab__icon material-icons">swap_horiz</span>
    </button>
    <!-- <div class="drawer-container"> -->
    <aside class="mdc-drawer mdc-drawer--dismissible mdc-drawer--open">
        <div class="mdc-drawer__content">
            <nav class="mdc-list my-markers-container">

                <div class="width-100">
                    <button class="mdc-icon-button my-mdc-fab material-icons" onclick="toggleDrawer()">
                        swap_horiz
                    </button>
                    <a class="mdc-list-item locations-title" href="javascript:" aria-selected="true">
                        <i class="material-icons mdc-list-item__graphic" aria-hidden="true">apps</i>
                        <h3 class="mdc-list-item__text width-100">
                            Locations
                        </h3>
                    </a>
                </div>
                <script>
                    function toggleDrawer() {
                        let viewModel = ko.dataFor(document.body);
                        viewModel.isDrawerOpen(!drawer.open)
                        drawer.open = !drawer.open;
                    };
                </script>

                <div class="locations-container">
                    <div data-bind="ifnot: hasFilter">
                        <div data-bind="foreach: markers">
                            <li class="mdc-list-item my-list-item" data-bind="text: address_name, attr: {'data-center': center}" onclick="handleClick(event)"></li>
                        </div>
                    </div>
                    <div data-bind="if: hasFilter">
                        <div data-bind="foreach: filteredElements">
                            <li class="mdc-list-item my-list-item" data-bind="text: address_name, attr: {'data-center': center}" onclick="handleClick(event)"></li>
                        </div>
                    </div>
                    <script>
                        function handleClick(e) {
                            let viewModel = ko.dataFor(document.body)

                            let center = e.target
                                .getAttribute("data-center")
                                .split(",")

                            if (viewModel.markersMode())
                                centerOnThisMarker()
                            else
                                selectDirectionPoints()

                            function centerOnThisMarker() {
                                if (map) map.flyTo({ center })
                            }

                            function selectDirectionPoints() {

                                if (!viewModel.origin()) {
                                    viewModel.origin({ x: center[0], y: center[1] })
                                    e.target.className += ' directions-origin'
                                    centerOnThisMarker()
                                    console.log("e target >>", e.target)

                                } else if (!viewModel.destination()) {
                                    viewModel.destination({ x: center[0], y: center[1] })
                                    e.target.className += ' directions-destination'
                                    discoverDirections()
                                    console.log("e target >>", e.target)
                                } else if (alertdialog) alertdialog.open()

                            }

                        }

                    </script>
                </div>
                <div class="mdc-tab-bar" role="tablist">
                    <div class="mdc-tab-scroller">
                        <div class="mdc-tab-scroller__scroll-area">
                            <div class="mdc-tab-scroller__scroll-content">
                                <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">place</span>
                                    </span>
                                    <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                                <button class="mdc-tab " role="tab" aria-selected="false">
                                    <span class="mdc-tab__content">
                                        <span class="mdc-tab__icon material-icons" aria-hidden="true">near_me</span>
                                    </span>
                                    <span class="mdc-tab-indicator">
                                        <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                    </span>
                                    <span class="mdc-tab__ripple"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="text-field-container input-container">
                        <div class="mdc-text-field text-field mdc-text-field--no-label mdc-ripple-upgraded my-input">
                            <input type="text" id="text-field-filled" class="mdc-text-field__input" aria-label="Text field aria label" data-bind="textInput: filterQuery">
                            <div class="mdc-line-ripple"></div>
                        </div>
                        <div class="mdc-text-field-helper-line">
                            <p class="mdc-text-field-helper-text 
                                        mdc-text-field-helper-text--persistent 
                                        mdc-text-field-helper-text--validation-msg" id="pw-validation-msg">
                                Search your locations
                            </p>
                        </div>
                    </div>

                </div>
            </nav>

        </div>
    </aside>
    <!-- </div> -->

    <!-- MDCDialog -->
    <!-- Alert Dialog -->
    <div class="mdc-dialog" id="alertdialog" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title" aria-describedby="my-dialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                <h2 class="mdc-dialog__title" id="my-dialog-title">
                    <!--
                    -->
                    Are you sure?
                    <!-- 
            -->
                </h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    This action will clear both origin and destination points.
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="no">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="yes" onclick="clearPointsAndRoute()">
                        <span class="mdc-button__label">Ok, clear</span>
                    </button>
                </footer>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <!-- end Alert Dialog -->
    <!-- Confirmation Dialog -->
    <div class="mdc-dialog" id="confirmationdialog" role="alertdialog" aria-modal="true" aria-labelledby="my-cdialog-title" aria-describedby="my-cdialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <!-- Title cannot contain leading whitespace due to mdc-typography-baseline-top() -->
                <h2 class="mdc-dialog__title" id="my-dialog-title">
                    <!--
                        -->Choose a travel profile
                    <!--
                    -->
                </h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    <ul class="mdc-list">
                        <li class="my-radio-list" tabindex="0">
                            <span class="mdc-list-item__graphic">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="test-dialog-baseline-confirmation-radio-1" name="test-dialog-baseline-confirmation-radio-group"
                                        checked data-bind="checked: travelProfile, checkedValue: 'cycling'">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                </div>
                            </span>
                            <label id="test-dialog-baseline-confirmation-radio-1-label" for="test-dialog-baseline-confirmation-radio-1" class="mdc-list-item__text">
                                Cycling
                            </label>
                        </li>
                        <li class="my-radio-list" tabindex="1">
                            <span class="mdc-list-item__graphic">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="test-dialog-baseline-confirmation-radio-2" name="test-dialog-baseline-confirmation-radio-group"
                                        data-bind="checked: travelProfile, checkedValue: 'driving'">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                </div>
                            </span>
                            <label id="test-dialog-baseline-confirmation-radio-2-label" for="test-dialog-baseline-confirmation-radio-2" class="mdc-list-item__text">
                                Driving
                            </label>
                        </li>
                        <li class="my-radio-list" tabindex="2">
                            <span class="mdc-list-item__graphic">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="test-dialog-baseline-confirmation-radio-3" name="test-dialog-baseline-confirmation-radio-group"
                                        data-bind="checked: travelProfile, checkedValue: 'walking'">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                </div>
                            </span>
                            <label id="test-dialog-baseline-confirmation-radio-3-label" for="test-dialog-baseline-confirmation-radio-3" class="mdc-list-item__text">
                                Walking
                            </label>
                        </li>
                        <!-- ... -->
                    </ul>
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="close">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="accept" onclick="handleConfirmation()">
                        <span class="mdc-button__label">OK</span>
                    </button>
                </footer>
            </div>
            <script>
                function handleConfirmation() {
                    const viewModel = ko.dataFor(document.body)
                    if (viewModel.origin() && viewModel.destination())
                        discoverDirections();
                }
            </script>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <!-- end Confirmation Dialog -->
    <!-- end MDCDialog -->

    <!-- MDCSnackbar -->
    <div class="mdc-snackbar mdc-snackbar--closing">
        <div class="mdc-snackbar__surface">
            <div class="mdc-snackbar__label" role="status" aria-live="polite">
                <div>Choose your origin and destination points</div>
                <div>by clicking your locations' list items!</div>
            </div>

        </div>
    </div>
    <!-- end MDCSnackbar -->

    <script src="./js/ViewModel.js"></script>
    <script>

        const drawer = new mdc.drawer.MDCDrawer.attachTo(document.querySelector('.mdc-drawer'));
        const tabBar = new mdc.tabBar.MDCTabBar(document.querySelector('.mdc-tab-bar'));
        const alertdialog = new mdc.dialog.MDCDialog(document.querySelector('#alertdialog'));
        const confirmationdialog = new mdc.dialog.MDCDialog(document.querySelector('#confirmationdialog'));
        const snackbar = new mdc.snackbar.MDCSnackbar(document.querySelector('.mdc-snackbar'));

        // const select = new mdc.select.MDCSelect(document.querySelector('.mdc-select'));

        // select.listen('MDCSelect:change', () => {
        //     console.log(`Selected option at index ${select.selectedIndex} with value "${select.value}"`);
        // });

    </script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
    <script>
        const mapBoxAccessToken = `pk.eyJ1IjoicmVpc21hdGhldXM5NyIsImEiOiJjanV5eHhtNjkxMjJnM3lydmFqdjBodXB4In0.B97LD8MDr6PdY2LiEWvhEA`;
        mapboxgl.accessToken = mapBoxAccessToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v11',
            center: [-43.17614100000003, -22.910430000000034],
            zoom: 14,
        });

        var geojson = {
            "type": "FeatureCollection",
            "features": []
        };

        // Used to draw a line between points
        var linestring = {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": []
            }
        };

        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            zoom: 17,
            placeholder: "Where?",
            reverseGeocode: true
        }));

        map.addControl(new mapboxgl.NavigationControl());

        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }));

        map.on('click', createMarker);

        // Create an marker and add it to the map
        function createMarker(e) {
            let center = [e.lngLat.lng, e.lngLat.lat]

            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
                `${center[0]},${center[1]}.json?access_token=${mapBoxAccessToken}`

            const viewModel = ko.dataFor(document.body)
            let address_name = "",
                place = "",
                country = ""

            if (viewModel.markersMode()) {
                $.get({
                    url,
                    context: document.body
                }).done(function (result) {

                    if (result.features && result.features.length > 0) {
                        console.log('mapbox result >>', result)
                        if (result.features[0].place_name) {
                            address_name = result.features[0].place_name.split(",").splice(0, 1).join();
                        }

                        place = result.features.find(it => it.place_type == "place")
                        country = result.features.find(it => it.place_type == "country")

                        if (place) {
                            address_name += ", " + place.text
                            place = place.text
                        }

                        if (country) {
                            let country_code = country.properties.short_code.toUpperCase();
                            address_name += ", " + country_code
                            contry = country_code
                        }

                    } else {
                        address_name = "No where!"
                    }

                }).fail(function (xhr, textStatus, errorThrown) {
                    console.warn("Fail to fetch mapbox geocoding API. " + (errorThrown || ""));
                    address_name = ""
                }).always(function () {
                    viewModel.addMarker({
                        center,
                        address_name,
                    });

                    let popup = new mapboxgl.Popup({
                        offset: 1,
                        anchor: 'top',
                        closeOnClick: false
                    })
                        .setDOMContent(
                            cardTemplate(
                                address_name.split(",").splice(0, 1).join(),
                                address_name.split(",").splice(1).join()
                            )
                        )
                        .setLngLat(center);
                    let markerContainer = document.createElement('div');
                    markerContainer.className = 'marker-container';
                    let markerIcon = document.createElement('i');
                    markerIcon.className = 'material-icons marker';
                    markerIcon.textContent = 'place';
                    markerIcon.onclick = function (e) {
                        e.stopPropagation();
                        popup.addTo(map)
                        map.easeTo({ center });
                    };
                    markerContainer.appendChild(markerIcon);

                    map.easeTo({ center });

                    let marker = new mapboxgl.Marker(markerContainer)
                        .setLngLat(center)
                        .addTo(map)

                })
            } else {
                map.flyTo({ center });
            }

        }
        // End create marker

        function fetchFoursquareAPI() {

            const viewModel = ko.dataFor(document.body)
            const foursquareClientID = `EHBZPGPP5CFESEZAXKUORTOT5EMHUHKZPA1DRAXC3MYLFH2R`
            const foursquareClientSecret = `FFYFDZLLIYO2OKN3VUJZIQ0WM2GTQIPTZHXZAEDXSIWJFHE1`
            let foursquareUrl = `https://api.foursquare.com/v2/venues/search?ll=
                -22.910430000000034,-43.17614100000003&client_id=${foursquareClientID}
                &client_secret=${foursquareClientSecret}&v=20190401&limit=10`

            $.get({
                url: foursquareUrl,
                context: document.body
            }).done(function (result) {
                debugger;
                if (
                    result.response && 
                    result.response.venues && 
                    result.response.venues.length > 0
                ) {
                    console.log("Foursquare API response >>", result)
                    result.response.venues.map(
                        it => {
                            let venue = {}
                            let address_name = ""

                            venue = {
                                name: it.name,
                                center: [it.location.lng, it.location.lat]
                            }

                            if (it.location.address) {
                                address_name = it.location.address + ", " + it.location.city + ", " + it.location.cc
                                venue = { ...venue, address_name }
                            }
                            return venue
                        }
                    )
                }

            }).fail(function (xhr, textStatus, errorThrown) {
                console.warn("Fail to fetch Foursquare API. " + (errorThrown || ""));
                // address_name = ""
            })
        }

        function htmlToElement(html) {
            let templateEl = document.createElement('template');
            html = html.trim();
            templateEl.innerHTML = html;
            return templateEl.content.firstChild;
        }

        function cardTemplate(title, subtitle) {
            let template = `
            <div class="mdc-card">
                <div class="mdc-card__primary-action mdc-card-title-custom">    
                    <span class="mdc-typography mdc-typography--subtitle1">${title}</span>
                    <span class="mdc-typography mdc-typography--subtitle2">${subtitle}</span>
                </div>
                <div class="mdc-card__actions">
                    <div class="mdc-card__action-buttons">
                    <button class="mdc-button mdc-card__action mdc-card__action--button" onclick="fetchFoursquareAPI()">
                        <span class="mdc-button__label">Find nearby places</span>
                        <i class="material-icons mdc-button__icon" aria-hidden="true">search</i>
                    </button>
                    </div>
                    <div class="mdc-card__action-icons">
                    <button class="material-icons mdc-icon-button mdc-card__action mdc-card__action--icon" title="More options">more_vert</button>
                    </div>
                </div>
            </div>
            `
            template = htmlToElement(template)
            return template
        }

        function clearPointsAndRoute() {
            const viewModel = ko.dataFor(document.body);

            if (viewModel.origin()) {
                document.querySelector(".directions-origin")
                    .classList.remove("directions-origin");

                if (viewModel.destination()) {
                    document.querySelector(".directions-destination")
                        .classList.remove("directions-destination");

                    map.removeLayer('route');
                    map.removeSource('route');
                }

            }

            viewModel.origin("");
            viewModel.destination("");

        }

        function discoverDirections() {

            const viewModel = ko.dataFor(document.body)
            const A = viewModel.origin()
            const B = viewModel.destination()
            const profile = viewModel.travelProfile();

            const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/${profile.toLowerCase()}/` +
                `${A.x},${A.y};${B.x},${B.y}?` +
                `overview=full&geometries=geojson&access_token=` + mapBoxAccessToken;

            $.get({
                url: directionsUrl
            })
                .done(function (result) {
                    console.log("result >>", result)
                    if (result.routes && result.routes.length > 0) {
                        let data = result.routes[0];
                        let route = data.geometry.coordinates;
                        let geojson = {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'LineString',
                                coordinates: route
                            }
                        };

                        if (map.getSource('route')) {
                            map.getSource('route').setData(geojson);
                        } else {
                            map.addLayer({
                                id: 'route',
                                type: 'line',
                                source: {
                                    type: 'geojson',
                                    data: {
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'LineString',
                                            coordinates: geojson
                                        }
                                    }
                                },
                                layout: {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                paint: {
                                    'line-color': '#6200ee',
                                    'line-width': 5,
                                    'line-opacity': 1
                                }
                            })
                            map.getSource('route').setData(geojson);
                        }

                    }
                })
                .fail(function (xhr, textStatus, errorThrown) {
                    console.warn("Fail to fetch mapbox directions API. " + (errorThrown || ""));
                })

        }


    </script>

</body>

</html>