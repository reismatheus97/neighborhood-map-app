<!DOCTYPE html>
<html>

<head>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script> -->
    <title>Neighborhood Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />

    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.0/knockout-min.js"></script>


</head>

<body>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.6/mapbox-gl-geocoder.css'
        type='text/css' />
    <div id='map'></div>
    <pre id='coordinates' class='coordinates'></pre>
    <section class="control-btn-container control-btn-margins mapboxgl-ctrl mapboxgl-ctrl-group">
        <button class="mapboxgl-ctrl-icon">1</button>
        <button class="mapboxgl-ctrl-icon">2</button>
    </section>
    <div class="my-div">
        <aside class="mdc-drawer">
            <div class="mdc-drawer__content">
                <nav class="mdc-list my-markers-container">

                    <div>
                        <a class="mdc-list-item mdc-list-item--activated" href="#" aria-selected="true">
                            <i class="material-icons mdc-list-item__graphic" aria-hidden="true">apps</i>
                            <h3 class="mdc-list-item__text">Locations</h3>
                        </a>
                    </div>

                    <div class="locations-container">
                        <div data-bind="ifnot: hasFilter">
                            <div data-bind="foreach: markers">
                                <li class="mdc-list-item my-list-item" data-bind="text: place_name, attr: {'data-center': center}" onclick="centerOnThisMarker(event)"></li>
                            </div>
                        </div>
                        <div data-bind="if: hasFilter">
                            <div data-bind="foreach: filteredElements">
                                <li class="mdc-list-item my-list-item" data-bind="text: place_name, attr: {'data-center': center}" onclick="centerOnThisMarker(event)"></li>
                            </div>
                        </div>
                        <script>
                            function centerOnThisMarker(e) {
                                if (map)
                                    map.flyTo({
                                        center: e.target
                                            .getAttribute("data-center")
                                            .split(",")
                                    })
                            }
                        </script>
                    </div>
                    <div class="mdc-tab-bar" role="tablist">
                        <div class="mdc-tab-scroller">
                            <div class="mdc-tab-scroller__scroll-area">
                                <div class="mdc-tab-scroller__scroll-content">
                                    <button class="mdc-tab mdc-tab--active" role="tab" aria-selected="true">
                                        <span class="mdc-tab__content">
                                            <span class="mdc-tab__icon material-icons" aria-hidden="true">place</span>
                                        </span>
                                        <span class="mdc-tab-indicator mdc-tab-indicator--active">
                                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                        </span>
                                        <span class="mdc-tab__ripple"></span>
                                    </button>
                                    <button class="mdc-tab " role="tab" aria-selected="false">
                                        <span class="mdc-tab__content">
                                            <span class="mdc-tab__icon material-icons" aria-hidden="true">favorite</span>
                                        </span>
                                        <span class="mdc-tab-indicator">
                                            <span class="mdc-tab-indicator__content mdc-tab-indicator__content--underline"></span>
                                        </span>
                                        <span class="mdc-tab__ripple"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="text-field-container my-input">
                            <div class="mdc-text-field text-field mdc-text-field--no-label mdc-ripple-upgraded">
                                <input type="text" id="text-field-filled" class="mdc-text-field__input" aria-label="Text field aria label" data-bind="textInput: filterQuery">
                                <div class="mdc-line-ripple"></div>
                            </div>
                            <div class="mdc-text-field-helper-line">
                                <p class="mdc-text-field-helper-text 
                                        mdc-text-field-helper-text--persistent 
                                        mdc-text-field-helper-text--validation-msg" id="pw-validation-msg">
                                    Search your locations
                                </p>
                            </div>
                        </div>

                    </div>
                </nav>

            </div>
        </aside>
    </div>

    <script src="./js/app.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
    <script>

        const tabBar = new mdc.tabBar.MDCTabBar(document.querySelector('.mdc-tab-bar'))

        const accessToken = `pk.eyJ1IjoicmVpc21hdGhldXM5NyIsImEiOiJjanRncWRiZTQwNWxjNDRsZms1djc1NHIyIn0.fvM81OoCXOijNBcWWDtBMA`;
        mapboxgl.accessToken = accessToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v11',
            center: [-87.637596, 41.940403],
            zoom: 12,
        });

        var geojson = {
            "type": "FeatureCollection",
            "features": []
        };

        // Used to draw a line between points
        var linestring = {
            "type": "Feature",
            "geometry": {
                "type": "LineString",
                "coordinates": []
            }
        };

        function forwardGeocoder(query) {
            var matchingFeatures = [];
            for (var i = 0; i < customData.features.length; i++) {
                var feature = customData.features[i];
                // handle queries with different capitalization than the source data by calling toLowerCase()
                if (feature.properties.title.toLowerCase().search(query.toLowerCase()) !== -1) {
                    // add a tree emoji as a prefix for custom data results
                    // using carmen geojson format: https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                    feature['place_name'] = 'ðŸŒ² ' + feature.properties.title;
                    feature['center'] = feature.geometry.coordinates;
                    feature['place_type'] = ['park'];
                    matchingFeatures.push(feature);
                }
            }
            return matchingFeatures;
        }

        map.addControl(new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            localGeocoder: forwardGeocoder,
            zoom: 14,
            placeholder: "Where?"
        }));

        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }));

        map.addControl(new mapboxgl.NavigationControl());

        map.on('click', createMarker);

        // Create an marker and add it to the map
        function createMarker(e) {
            let center = [e.lngLat.lng, e.lngLat.lat]

            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/` +
                `${center[0]},${center[1]}.json?access_token=${accessToken}`

            const viewModel = ko.dataFor(document.body)
            let place_name = ""

            $.get({
                url,
                context: document.body
            }).done(function (result) {

                if (result.features && result.features.length > 0) {

                    if (result.features[0].place_name) {
                        place_name = result.features[0].place_name.split(",").splice(0, 2).join();
                    }

                    let country = result.features.find(it => it.place_type == "country")

                    if (country) {
                        let country_code = country.properties.short_code.toUpperCase();
                        place_name += ", " + country_code;
                    }

                } else {
                    place_name = "No where!"
                }

            }).fail(function (xhr, textStatus, errorThrown) {
                console.warn("Fail to fetch mapbox geocoding API. " + (errorThrown || ""));
                place_name = ""
            }).always(function () {
                viewModel.addMarker({ center, place_name });
            })
            
            let el = document.createElement('i');
            el.className = 'material-icons marker';      
            el.textContent = 'place';

            map.flyTo({ center });
            var marker = new mapboxgl.Marker(el)
                .setLngLat(center)
                .addTo(map)
            
            const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/cycling/` +
                `${center[0]},${center[1]};-84.512023,39.102779?` +
                `overview=full&geometries=geojson&access_token=` + accessToken;

            $.get({
                url: directionsUrl
            })
                .done(function (result) {
                    console.log("result >>", result)
                    if (result.routes && result.routes.length > 0) {
                        let data = result.routes[0];
                        let route = data.geometry.coordinates;
                        let geojson = {
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'LineString',
                                coordinates: route
                            }
                        };

                        if (map.getSource('route')) {
                            map.getSource('route').setData(geojson);
                        } else {
                            map.addLayer({
                                id: 'route',
                                type: 'line',
                                source: {
                                    type: 'geojson',
                                    data: {
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'LineString',
                                            coordinates: geojson
                                        }
                                    }
                                },
                                layout: {
                                    'line-join': 'round',
                                    'line-cap': 'round'
                                },
                                paint: {
                                    'line-color': '#6200ee',
                                    'line-width': 5,
                                    'line-opacity': 1
                                }
                            })
                        }

                    }
                })
                .fail(function (xhr, textStatus, errorThrown) {
                    console.warn("Fail to fetch mapbox directions API. " + (errorThrown || ""));
                })

        }
        // End create marker


    </script>

</body>

</html>